"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { ArrowLeft, ZoomIn, ZoomOut, Eye, EyeOff, Sparkles, UserCheck, Smartphone } from "lucide-react";
import type { ParoRecord } from "@/lib/types";
import SimpleDentalChart from "@/components/SimpleDentalChart";
import { supabase } from "@/lib/supabase";
import { useAuth } from "@/lib/auth-context";

export default function RecordDetailPage() {
  const params = useParams();
  const router = useRouter();
  const { user } = useAuth();
  const [record, setRecord] = useState<ParoRecord | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [fontSize, setFontSize] = useState(100); // 100% = default
  const [showFieldStatus, setShowFieldStatus] = useState(true); // Zelen√©/kor√°lov√© ohraniƒçen√≠
  const [sendingToPhone, setSendingToPhone] = useState(false);

  useEffect(() => {
    async function loadRecord() {
      try {
        console.log("üîç Fetching record:", params.id);
        
        // P≈ô√≠m√Ω Supabase dotaz s RLS
        const { data, error } = await supabase
          .from("paro_records")
          .select("*")
          .eq("id", params.id)
          .eq("deleted", false)
          .single();
        
        if (error) {
          console.error("‚ùå Supabase error:", error);
          throw new Error(error.message);
        }
        
        if (!data) {
          throw new Error("Z√°znam nenalezen");
        }
        
        console.log("‚úÖ Found record:", data);
        setRecord(data as ParoRecord);
      } catch (err) {
        console.error("‚ùå Failed to load record:", err);
        setError(err instanceof Error ? err.message : "Nezn√°m√° chyba");
      } finally {
        setLoading(false);
      }
    }
    loadRecord();
  }, [params.id]);

  const sendToPhone = async () => {
    if (!user || !record) return;
    
    setSendingToPhone(true);
    
    try {
      const { data, error } = await supabase
        .from('record_notifications')
        .insert({
          user_id: user.id,
          record_id: record.id,
          action: 'open_record'
        })
        .select()
        .single();
      
      if (error) throw error;
      
      console.log('‚úÖ Notifikace odesl√°na do telefonu:', data);
      
      // Zobraz success feedback (m≈Ø≈æe≈° p≈ôidat toast pozdƒõji)
      alert('‚úÖ Z√°znam odesl√°n do telefonu!');
    } catch (err) {
      console.error('‚ùå Chyba p≈ôi odes√≠l√°n√≠ do telefonu:', err);
      alert('‚ùå Nepoda≈ôilo se odeslat z√°znam do telefonu');
    } finally {
      setSendingToPhone(false);
    }
  };

  if (loading) {
    return (
      <div className="h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
          <p className="text-sm text-gray-500">Naƒç√≠t√°n√≠ z√°znamu...</p>
        </div>
      </div>
    );
  }

  if (error || !record) {
    return (
      <div className="h-screen flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600 font-semibold mb-2">Chyba: {error || "Z√°znam nenalezen"}</p>
          <button onClick={() => router.back()} className="text-blue-600 hover:underline">
            ‚Üê Zpƒõt na z√°znamy
          </button>
        </div>
      </div>
    );
  }

  const fd = record.form_data;
  
  // Helper pro kontrolu jestli je pole vyplnƒõn√©
  const isFieldFilled = (value: any) => {
    return value !== null && value !== undefined && value !== '' && value !== 'N/A';
  };

  // Helper pro zv√Ωraznƒõn√≠ nevyu≈æit√Ωch slov v p≈ôepisu
  const highlightUnusedWords = (transcript: string) => {
    if (!transcript) return null;

    // Z√≠skat v≈°echny hodnoty z formul√°≈ôe jako text
    const formValues = Object.values(fd).filter(v => v && typeof v === 'string').join(' ').toLowerCase();
    
    // Rozdƒõlit p≈ôepis na slova
    const words = transcript.split(/(\s+)/); // Zachovat mezery
    
    return words.map((word, idx) => {
      // Ignorovat mezery a interpunkci
      const cleanWord = word.replace(/[.,;:!?()]/g, '').toLowerCase();
      if (!cleanWord || cleanWord.length < 3) return word; // Ignorovat kr√°tk√° slova
      
      // Zkontrolovat jestli je slovo v formul√°≈ôi
      const isUsed = formValues.includes(cleanWord);
      
      return isUsed ? word : (
        <mark key={idx} className="bg-yellow-200 px-0.5">{word}</mark>
      );
    });
  };
  
  // Helper pro z√≠sk√°n√≠ input classy s kor√°lovƒõ ohraniƒçen√≠m pr√°zdn√Ωch pol√≠
  const getInputClass = (value: any, baseClass: string = "w-full px-3 py-2 border border-gray-300 rounded text-sm") => {
    if (!showFieldStatus) return baseClass;
    if (isFieldFilled(value)) return baseClass;
    // Kor√°lov√° ƒçerven√° z mobiln√≠ app (#FF6B6B)
    return baseClass.replace('border-gray-300', 'border-[#FF6B6B]');
  };
  
  // Komponenta pro status ikonu u labelu - inverzn√≠ (kruh barevn√Ω, symbol b√≠l√Ω)
  const FieldStatusIcon = ({ value }: { value: any }) => {
    if (!showFieldStatus) return null;
    
    return isFieldFilled(value) ? (
      <span className="inline-flex items-center justify-center w-4 h-4 rounded-full bg-green-500 ml-1">
        <svg width="10" height="10" viewBox="0 0 10 10" fill="none" className="text-white">
          <path d="M8.5 2.5L3.75 7.25L1.5 5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
        </svg>
      </span>
    ) : (
      <span className="inline-flex items-center justify-center w-4 h-4 rounded-full ml-1" style={{ backgroundColor: '#FF6B6B' }}>
        <svg width="10" height="10" viewBox="0 0 10 10" fill="none" className="text-white">
          <path d="M2.5 2.5L7.5 7.5M7.5 2.5L2.5 7.5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
        </svg>
      </span>
    );
  };

  return (
    <div className="h-screen flex flex-col bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b px-2 py-1.5 flex items-center gap-2 shrink-0">
        <button onClick={() => router.back()} className="p-1 hover:bg-gray-100 rounded">
          <ArrowLeft size={18} />
        </button>
        <div className="flex-1">
          <h1 className="text-sm font-semibold text-gray-900">{fd.lastName || "Bez jm√©na"}</h1>
        </div>
        
        {/* Controls */}
        <div className="flex items-center gap-1.5 border-l pl-2">
          {/* Odeslat do telefonu */}
          <button
            onClick={sendToPhone}
            disabled={sendingToPhone}
            className={`p-1 rounded transition ${sendingToPhone ? 'opacity-50 cursor-wait' : 'hover:bg-blue-50'} text-blue-600`}
            title="Odeslat z√°znam do telefonu"
          >
            <Smartphone size={16} />
          </button>
          
          {/* LLM tuning (nefunkƒçn√≠ zat√≠m) */}
          <button
            className="p-1 rounded transition hover:bg-purple-50 text-purple-600 opacity-50 cursor-not-allowed"
            title="Ladƒõn√≠ LLM (brzy k dispozici)"
            disabled
          >
            <Sparkles size={16} />
          </button>
          
          {/* Hygienist correction (nefunkƒçn√≠ zat√≠m) */}
          <button
            className="p-1 rounded transition hover:bg-blue-50 text-blue-600 opacity-50 cursor-not-allowed"
            title="Oprava hygienistkou (brzy k dispozici)"
            disabled
          >
            <UserCheck size={16} />
          </button>
          
          {/* Field status toggle */}
          <button
            onClick={() => setShowFieldStatus(!showFieldStatus)}
            className={`p-1 rounded transition ${showFieldStatus ? 'bg-green-50 text-green-600' : 'hover:bg-gray-100 text-gray-600'}`}
            title={showFieldStatus ? "Skr√Ωt status pol√≠" : "Zobrazit status pol√≠"}
          >
            {showFieldStatus ? <Eye size={16} /> : <EyeOff size={16} />}
          </button>
          
          {/* Zoom controls */}
          <div className="flex items-center gap-0.5 border-l pl-1.5">
            <button 
              onClick={() => setFontSize(Math.max(70, fontSize - 10))}
              className="p-1 hover:bg-gray-100 rounded"
              title="Zmen≈°it text"
            >
              <ZoomOut size={16} />
            </button>
            <span className="text-[10px] text-gray-600 w-8 text-center">{fontSize}%</span>
            <button 
              onClick={() => setFontSize(Math.min(150, fontSize + 10))}
              className="p-1 hover:bg-gray-100 rounded"
              title="Zvƒõt≈°it text"
            >
              <ZoomIn size={16} />
            </button>
          </div>
        </div>
        
        <div className="text-[10px] text-gray-500">{new Date(record.created_at).toLocaleDateString("cs-CZ")}</div>
      </div>

      {/* Main content wrapper with scroll */}
      <div className="flex-1 overflow-y-auto">
        {/* Grid: 2 boƒçn√≠ sloupce + prost≈ôedn√≠ na celou ≈°√≠≈ôku */}
        <div 
          className="grid grid-cols-[280px_1fr_320px] gap-1.5 p-1.5"
          style={{ transform: `scale(${fontSize / 100})`, transformOrigin: 'top left', width: `${100 / (fontSize / 100)}%` }}
        >
        {/* LEFT COLUMN - beze zmƒõny */}
        
        {/* LEFT COLUMN */}
        <div className="space-y-2">
          {/* Z√°kladn√≠ informace */}
          <div className="bg-white rounded shadow-sm p-2">
            <h3 className="font-semibold text-xs mb-2">Z√°kladn√≠ informace</h3>
            
            <div className="space-y-2">
              <div>
                <label className="block text-xs text-gray-600 mb-1">
                  P≈ô√≠jmen√≠
                  <FieldStatusIcon value={fd.lastName} />
                </label>
                <input type="text" value={fd.lastName || ""} readOnly className={getInputClass(fd.lastName, "w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium")} />
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">
                  Rodn√© ƒç√≠slo (Rƒå)
                  <FieldStatusIcon value={fd.personalIdNumber} />
                </label>
                <input type="text" value={fd.personalIdNumber || ""} readOnly className={getInputClass(fd.personalIdNumber, "w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium")} />
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">Ku≈ô√°k</label>
                <div className="flex gap-3">
                  <label className="flex items-center gap-1">
                    <input type="radio" checked={fd.isSmoker === "yes"} readOnly className="w-4 h-4" />
                    <span className="text-sm font-medium">Ano</span>
                  </label>
                  <label className="flex items-center gap-1">
                    <input type="radio" checked={fd.isSmoker === "no"} readOnly className="w-4 h-4" />
                    <span className="text-sm font-medium">Ne</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          {/* Anamn√©za */}
          <div className="bg-white rounded shadow-sm p-2">
            <h3 className="font-semibold text-xs mb-2">Anamn√©za</h3>
            
            <div className="space-y-2">
              <div>
                <label className="block text-xs text-gray-600 mb-1">
                  V≈°eobecn√° anamn√©za
                  <FieldStatusIcon value={fd.generalAnamnesis} />
                </label>
                <textarea value={fd.generalAnamnesis || ""} readOnly rows={2} className={getInputClass(fd.generalAnamnesis, "w-full px-2 py-1 border border-gray-300 rounded text-sm resize-none leading-relaxed")} />
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">
                  Alergie
                  <FieldStatusIcon value={fd.allergies} />
                </label>
                <textarea value={fd.allergies || ""} readOnly rows={2} className={getInputClass(fd.allergies, "w-full px-2 py-1 border border-gray-300 rounded text-sm resize-none leading-relaxed")} />
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">
                  Stomatologick√° anamn√©za
                  <FieldStatusIcon value={fd.stomatologicalAnamnesis} />
                </label>
                <textarea value={fd.stomatologicalAnamnesis || ""} readOnly rows={2} className={getInputClass(fd.stomatologicalAnamnesis, "w-full px-2 py-1 border border-gray-300 rounded text-sm resize-none leading-relaxed")} />
              </div>
            </div>
          </div>
        </div>

        {/* CENTER COLUMN - Zubn√≠ k≈ô√≠≈æ NAHO≈òE */}
        <div className="space-y-1.5">
          {/* Stav chrupu (zubn√≠ k≈ô√≠≈æ) - JEDNODUCH√ù S OBR√ÅZKEM */}
          <SimpleDentalChart 
            teeth={fd.dentalCross || {}}
            notes={fd.dentalCrossNotes}
            fontSize={fontSize}
          />
        </div>

        {/* RIGHT COLUMN */}
        <div className="space-y-2">
          {/* Vy≈°et≈ôen√≠ */}
          <div className="bg-white rounded shadow-sm p-2">
            <h3 className="font-semibold text-xs mb-2">Vy≈°et≈ôen√≠</h3>
            
            <div className="space-y-2">
              {[
                { label: "Hygiena", value: fd.hygiene },
                { label: "Gingiva", value: fd.gingiva },
                { label: "Zubn√≠ k√°men", value: fd.tartar },
                { label: "Pom≈Øcky", value: fd.tools }
              ].map(({ label, value }) => (
                <div key={label}>
                  <label className="block text-xs text-gray-600 mb-1">
                    {label}
                    <FieldStatusIcon value={value} />
                  </label>
                  <input type="text" value={value || ""} readOnly className="w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium" />
                </div>
              ))}
            </div>
          </div>

          {/* Indexy (BOP/PBI, CPITN) */}
          <div className="bg-white rounded shadow-sm p-2">
            <h3 className="font-semibold text-xs mb-2">Indexy (BOP/PBI, CPITN)</h3>
            
            <div className="space-y-2">
              <div>
                <label className="block text-xs text-gray-600 mb-1">BOP / PBI Protokol</label>
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="block text-[10px] text-gray-500 mb-1">
                      Datum
                      <FieldStatusIcon value={fd.pbiDate} />
                    </label>
                    <input type="date" value={fd.pbiDate || ""} readOnly className="w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium" />
                  </div>
                  <div>
                    <label className="block text-[10px] text-gray-500 mb-1">
                      V√Ωsledek
                      <FieldStatusIcon value={fd.pbiResult} />
                    </label>
                    <input type="text" value={fd.pbiResult || ""} readOnly className="w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium" />
                  </div>
                </div>
              </div>
              <div>
                <label className="block text-xs text-gray-600 mb-1">
                  Pom≈Øcky
                  <FieldStatusIcon value={fd.pbiTools} />
                </label>
                <input type="text" value={fd.pbiTools || ""} readOnly className="w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium" />
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Z√°znam o≈°et≈ôen√≠ + Kompletn√≠ p≈ôepis DOLE - ROZTA≈ΩEN√â P≈òES CELOU ≈†√ç≈òKU */}
      <div className="grid grid-cols-2 gap-3 px-1.5 pb-1.5">
        {/* Z√°znam o o≈°et≈ôen√≠ - LEV√Å POLOVINA */}
        <div className="bg-white rounded shadow-sm p-3">
          <h3 className="font-semibold text-lg mb-2">Z√°znam o o≈°et≈ôen√≠</h3>
          <textarea 
            value={fd.treatmentRecord || ""} 
            readOnly 
            rows={6} 
            className={getInputClass(fd.treatmentRecord, "w-full px-3 py-2 border-2 border-gray-300 rounded text-lg font-medium resize-none leading-relaxed")} 
          />
        </div>

        {/* Kompletn√≠ p≈ôepis - PRAV√Å POLOVINA */}
        <div className="bg-white rounded shadow-sm p-3">
          <h3 className="font-semibold text-lg mb-2">
            Kompletn√≠ p≈ôepis
            <span className="text-xs font-normal text-gray-500 ml-2">(≈ælutƒõ = nevyu≈æito)</span>
          </h3>
          <div className="bg-gray-50 border-2 border-gray-200 rounded px-3 py-2 h-[calc(100%-3rem)] overflow-y-auto">
            <p className="text-lg font-medium text-gray-800 whitespace-pre-wrap leading-relaxed">
              {highlightUnusedWords(fd.fullTranscript)}
            </p>
          </div>
        </div>
      </div>
      </div>
    </div>
  );
}
